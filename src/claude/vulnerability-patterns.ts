/**
 * Vulnerability Pattern Database
 * Contains regex patterns, detection hints, and remediation guidance for common vulnerability types
 */

export interface VulnerabilityPattern {
  id: string;
  name: string;
  category: string;
  cweIds: string[];
  owaspCategory?: string;
  description: string;
  searchPatterns: {
    regex: string;
    description: string;
    language?: string[];
    confidence: 'high' | 'medium' | 'low';
  }[];
  filePatterns: string[];
  antiPatterns?: string[]; // Patterns that indicate secure code (to reduce false positives)
  remediation: string;
  references: string[];
}

/**
 * Common vulnerability patterns database
 */
export const VULNERABILITY_PATTERNS: VulnerabilityPattern[] = [
  // SQL Injection
  {
    id: 'sqli',
    name: 'SQL Injection',
    category: 'Injection',
    cweIds: ['CWE-89', 'CWE-564'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'SQL Injection occurs when untrusted data is sent to an interpreter as part of a command or query.',
    searchPatterns: [
      {
        regex: '(SELECT|INSERT|UPDATE|DELETE|FROM|WHERE).*\\+.*\\$|\\$\\{.*\\}',
        description: 'String concatenation in SQL queries',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'f".*SELECT.*{|f".*INSERT.*{|f".*UPDATE.*{|f".*DELETE.*{',
        description: 'F-string SQL query construction',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: '\\.query\\s*\\(\\s*[`"\'].*\\$\\{',
        description: 'Template literal in database query',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'execute\\s*\\(.*%s.*%|execute\\s*\\(.*\\+',
        description: 'String formatting in SQL execute',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'raw\\s*\\(|rawQuery\\s*\\(',
        description: 'Raw SQL query execution',
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go'],
    antiPatterns: [
      '\\$\\d+', // Parameterized query placeholder ($1, $2)
      '\\?', // Prepared statement placeholder
      'prepare\\s*\\(',
      'parameterized',
    ],
    remediation: 'Use parameterized queries or prepared statements. Never concatenate user input directly into SQL strings.',
    references: [
      'https://owasp.org/www-community/attacks/SQL_Injection',
      'https://cwe.mitre.org/data/definitions/89.html',
    ],
  },

  // XSS (Cross-Site Scripting)
  {
    id: 'xss',
    name: 'Cross-Site Scripting (XSS)',
    category: 'Injection',
    cweIds: ['CWE-79', 'CWE-80'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'XSS attacks occur when an application includes untrusted data in a web page without proper validation or escaping.',
    searchPatterns: [
      {
        regex: 'innerHTML\\s*=|outerHTML\\s*=',
        description: 'Direct innerHTML assignment',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'dangerouslySetInnerHTML',
        description: 'React dangerouslySetInnerHTML usage',
        language: ['javascript', 'typescript', 'jsx', 'tsx'],
        confidence: 'medium',
      },
      {
        regex: 'document\\.write\\s*\\(',
        description: 'document.write usage',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'v-html\\s*=',
        description: 'Vue v-html directive',
        language: ['vue'],
        confidence: 'medium',
      },
      {
        regex: '\\{\\{\\{.*\\}\\}\\}|\\{\\{\\s*!',
        description: 'Unescaped template output',
        confidence: 'high',
      },
      {
        regex: '\\|\\s*safe\\s*\\}\\}',
        description: 'Django/Jinja safe filter',
        language: ['python', 'html'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.jsx', '**/*.tsx', '**/*.vue', '**/*.html', '**/*.php'],
    antiPatterns: [
      'textContent\\s*=',
      'createTextNode',
      'encodeURIComponent',
      'DOMPurify',
      'sanitize',
    ],
    remediation: 'Encode all user input before rendering. Use textContent instead of innerHTML. Implement Content Security Policy.',
    references: [
      'https://owasp.org/www-community/attacks/xss/',
      'https://cwe.mitre.org/data/definitions/79.html',
    ],
  },

  // Command Injection
  {
    id: 'cmdi',
    name: 'Command Injection',
    category: 'Injection',
    cweIds: ['CWE-78', 'CWE-77'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'Command injection occurs when an application passes unsafe user data to a system shell.',
    searchPatterns: [
      {
        regex: 'exec\\s*\\(.*\\+|exec\\s*\\(.*\\$\\{|exec\\s*\\(.*%',
        description: 'exec with string concatenation',
        confidence: 'high',
      },
      {
        regex: 'spawn\\s*\\(.*\\+|spawn\\s*\\(.*\\$\\{',
        description: 'spawn with dynamic command',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'child_process|subprocess|os\\.system|os\\.popen',
        description: 'Process execution imports',
        confidence: 'low',
      },
      {
        regex: 'shell\\s*=\\s*True|shell=True',
        description: 'Python subprocess with shell=True',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'Runtime\\.getRuntime\\(\\)\\.exec',
        description: 'Java Runtime.exec',
        language: ['java'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go', '**/*.rb'],
    antiPatterns: [
      'execFile\\s*\\(',
      'spawnSync\\s*\\([^,]+,\\s*\\[',
      'shlex\\.quote',
      'escapeshellarg',
    ],
    remediation: 'Avoid calling OS commands with user input. If necessary, use allowlists and proper escaping.',
    references: [
      'https://owasp.org/www-community/attacks/Command_Injection',
      'https://cwe.mitre.org/data/definitions/78.html',
    ],
  },

  // Path Traversal
  {
    id: 'path-traversal',
    name: 'Path Traversal',
    category: 'Injection',
    cweIds: ['CWE-22', 'CWE-23'],
    owaspCategory: 'A01:2021 - Broken Access Control',
    description: 'Path traversal attacks use special characters to access files outside the intended directory.',
    searchPatterns: [
      {
        regex: 'readFile.*\\+|readFileSync.*\\+',
        description: 'File read with concatenation',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'path\\.join\\s*\\([^)]*req\\.|path\\.resolve\\s*\\([^)]*req\\.',
        description: 'Path join with request data',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'open\\s*\\(.*\\+|open\\s*\\(.*%|open\\s*\\(.*f"',
        description: 'File open with user input',
        language: ['python'],
        confidence: 'medium',
      },
      {
        regex: 'sendFile\\s*\\(.*req\\.',
        description: 'Express sendFile with request data',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go'],
    antiPatterns: [
      'path\\.basename',
      'path\\.normalize',
      '\\.startsWith\\s*\\(',
      'realpath',
    ],
    remediation: 'Validate and sanitize file paths. Use basename to extract filename. Restrict access to specific directories.',
    references: [
      'https://owasp.org/www-community/attacks/Path_Traversal',
      'https://cwe.mitre.org/data/definitions/22.html',
    ],
  },

  // Insecure Deserialization
  {
    id: 'deserialization',
    name: 'Insecure Deserialization',
    category: 'Injection',
    cweIds: ['CWE-502'],
    owaspCategory: 'A08:2021 - Software and Data Integrity Failures',
    description: 'Insecure deserialization can allow attackers to execute code, bypass authentication, or escalate privileges.',
    searchPatterns: [
      {
        regex: 'pickle\\.loads?\\s*\\(|yaml\\.load\\s*\\([^)]*$|yaml\\.unsafe_load',
        description: 'Python unsafe deserialization',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'unserialize\\s*\\(|serialize\\s*\\(',
        description: 'PHP serialize/unserialize',
        language: ['php'],
        confidence: 'medium',
      },
      {
        regex: 'JSON\\.parse\\s*\\([^)]*\\)',
        description: 'JSON.parse (check for eval-like behavior)',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
      {
        regex: 'ObjectInputStream|readObject\\s*\\(',
        description: 'Java object deserialization',
        language: ['java'],
        confidence: 'medium',
      },
      {
        regex: 'eval\\s*\\(|Function\\s*\\(',
        description: 'Dynamic code evaluation',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'yaml\\.safe_load',
      'JSON\\.parse.*catch',
    ],
    remediation: 'Use safe deserialization methods. Validate and sanitize serialized data. Implement integrity checks.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/07-Testing_for_XML_Injection',
      'https://cwe.mitre.org/data/definitions/502.html',
    ],
  },

  // Hardcoded Secrets
  {
    id: 'hardcoded-secrets',
    name: 'Hardcoded Secrets',
    category: 'Sensitive Data Exposure',
    cweIds: ['CWE-798', 'CWE-259'],
    owaspCategory: 'A02:2021 - Cryptographic Failures',
    description: 'Hardcoded passwords, API keys, or other secrets in source code can be extracted by attackers.',
    searchPatterns: [
      {
        regex: '(password|passwd|pwd|secret|api_key|apikey|api-key|token|auth)\\s*[=:]\\s*["\'][^"\']{8,}["\']',
        description: 'Hardcoded credentials pattern',
        confidence: 'high',
      },
      {
        regex: 'AWS[A-Za-z0-9]{16,}|AKIA[A-Z0-9]{16}',
        description: 'AWS access key pattern',
        confidence: 'high',
      },
      {
        regex: 'sk_live_[a-zA-Z0-9]{24,}|pk_live_[a-zA-Z0-9]{24,}',
        description: 'Stripe API key pattern',
        confidence: 'high',
      },
      {
        regex: 'ghp_[a-zA-Z0-9]{36}|github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59}',
        description: 'GitHub token pattern',
        confidence: 'high',
      },
      {
        regex: 'Bearer\\s+[a-zA-Z0-9\\-_.~+/]+=*',
        description: 'Bearer token pattern',
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go', '**/*.env', '**/*.yml', '**/*.yaml', '**/*.json'],
    antiPatterns: [
      'process\\.env',
      'os\\.environ',
      'getenv\\s*\\(',
      'config\\.',
      'ENV\\[',
    ],
    remediation: 'Use environment variables or secret management systems. Never commit secrets to version control.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/01-Information_Gathering/05-Review_Webpage_Content_for_Information_Leakage',
      'https://cwe.mitre.org/data/definitions/798.html',
    ],
  },

  // SSRF (Server-Side Request Forgery)
  {
    id: 'ssrf',
    name: 'Server-Side Request Forgery',
    category: 'Server-Side',
    cweIds: ['CWE-918'],
    owaspCategory: 'A10:2021 - Server-Side Request Forgery',
    description: 'SSRF attacks can abuse server functionality to read or update internal resources.',
    searchPatterns: [
      {
        regex: 'fetch\\s*\\(.*req\\.|axios\\s*\\(.*req\\.|http\\.get\\s*\\(.*req\\.',
        description: 'HTTP request with user input URL',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'requests\\.get\\s*\\(.*request\\.|urllib\\.request\\.urlopen\\s*\\(',
        description: 'Python HTTP request with user input',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'curl_exec\\s*\\(|file_get_contents\\s*\\(.*\\$',
        description: 'PHP URL fetch with user input',
        language: ['php'],
        confidence: 'high',
      },
      {
        regex: 'new\\s+URL\\s*\\(.*req\\.',
        description: 'URL construction with request data',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go'],
    antiPatterns: [
      'allowlist',
      'whitelist',
      'isValidUrl',
      'validateUrl',
    ],
    remediation: 'Validate and sanitize user-supplied URLs. Use allowlists for permitted domains. Disable redirects.',
    references: [
      'https://owasp.org/www-community/attacks/Server_Side_Request_Forgery',
      'https://cwe.mitre.org/data/definitions/918.html',
    ],
  },

  // IDOR (Insecure Direct Object Reference)
  {
    id: 'idor',
    name: 'Insecure Direct Object Reference',
    category: 'Access Control',
    cweIds: ['CWE-639', 'CWE-284'],
    owaspCategory: 'A01:2021 - Broken Access Control',
    description: 'IDOR occurs when an application exposes internal implementation objects without proper authorization checks.',
    searchPatterns: [
      {
        regex: 'findById\\s*\\(.*req\\.params|findOne\\s*\\(.*req\\.params',
        description: 'Database query with direct ID from request',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: '\\.get\\s*\\(.*:id|\\[req\\.params\\.id\\]',
        description: 'Direct object access with request ID',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'User\\.objects\\.get\\s*\\(.*request\\.',
        description: 'Django direct object access',
        language: ['python'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'req\\.user\\.id',
      'currentUser',
      'authorize',
      'checkPermission',
      'canAccess',
    ],
    remediation: 'Implement proper authorization checks. Verify user ownership before accessing resources.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References',
      'https://cwe.mitre.org/data/definitions/639.html',
    ],
  },

  // Missing Authentication
  {
    id: 'missing-auth',
    name: 'Missing Authentication',
    category: 'Authentication',
    cweIds: ['CWE-306', 'CWE-287'],
    owaspCategory: 'A07:2021 - Identification and Authentication Failures',
    description: 'Endpoints that handle sensitive operations without requiring authentication.',
    searchPatterns: [
      {
        regex: 'app\\.(post|put|delete|patch)\\s*\\([^)]*,\\s*(async\\s*)?\\(req',
        description: 'Express route without auth middleware',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
      {
        regex: '@(Post|Put|Delete|Patch)\\s*\\([^)]*\\)\\s*\\n\\s*(async\\s+)?\\w+\\s*\\(',
        description: 'NestJS route without guard',
        language: ['typescript'],
        confidence: 'low',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'authenticate',
      'isAuthenticated',
      'requireAuth',
      '@UseGuards',
      '@login_required',
      'auth\\s*:',
    ],
    remediation: 'Implement authentication middleware for all sensitive endpoints.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/',
      'https://cwe.mitre.org/data/definitions/306.html',
    ],
  },

  // Weak Cryptography
  {
    id: 'weak-crypto',
    name: 'Weak Cryptography',
    category: 'Cryptographic Failures',
    cweIds: ['CWE-327', 'CWE-328'],
    owaspCategory: 'A02:2021 - Cryptographic Failures',
    description: 'Use of weak or broken cryptographic algorithms.',
    searchPatterns: [
      {
        regex: 'createHash\\s*\\(["\']md5["\']\\)|createHash\\s*\\(["\']sha1["\']\\)',
        description: 'Weak hash algorithm (MD5/SHA1)',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'hashlib\\.md5|hashlib\\.sha1',
        description: 'Python weak hash',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'DES|3DES|RC4|RC2|Blowfish',
        description: 'Weak encryption algorithm',
        confidence: 'high',
      },
      {
        regex: 'Math\\.random\\s*\\(|rand\\s*\\(\\)',
        description: 'Non-cryptographic random',
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go'],
    antiPatterns: [
      'sha256',
      'sha384',
      'sha512',
      'bcrypt',
      'argon2',
      'scrypt',
      'crypto\\.randomBytes',
      'secrets\\.',
    ],
    remediation: 'Use strong cryptographic algorithms (SHA-256+, AES-256, bcrypt/argon2 for passwords).',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/',
      'https://cwe.mitre.org/data/definitions/327.html',
    ],
  },

  // Slopsquatting / Hallucinated Packages
  {
    id: 'slopsquatting',
    name: 'Hallucinated Packages (Slopsquatting)',
    category: 'Supply Chain',
    cweIds: ['CWE-1357', 'CWE-829'],
    owaspCategory: 'A06:2021 - Vulnerable and Outdated Components',
    description: 'AI models may suggest packages that don\'t exist (5-21% rate). Attackers register these fake package names with malicious code.',
    searchPatterns: [
      {
        regex: 'import\\s+["\'][^"\']+["\']|require\\s*\\(["\'][^"\']+["\']\\)',
        description: 'JavaScript/TypeScript imports',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
      {
        regex: 'from\\s+\\w+\\s+import|import\\s+\\w+',
        description: 'Python imports',
        language: ['python'],
        confidence: 'low',
      },
      {
        regex: '"dependencies":\\s*\\{[^}]*\\}',
        description: 'package.json dependencies',
        language: ['json'],
        confidence: 'low',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/package.json', '**/requirements.txt', '**/Pipfile'],
    antiPatterns: [],
    remediation: 'Verify all packages exist on npm/pypi before using. Use lockfiles. Audit dependencies regularly.',
    references: [
      'https://socket.dev/blog/ai-generated-code-and-slopsquatting',
      'https://www.theregister.com/2024/03/28/ai_bots_hallucinate_software_packages/',
    ],
  },

  // Missing Input Validation
  {
    id: 'input-validation',
    name: 'Missing Input Validation',
    category: 'Input Validation',
    cweIds: ['CWE-20', 'CWE-1284'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'Failure to validate user input before processing. Root cause of most injection vulnerabilities.',
    searchPatterns: [
      {
        regex: 'req\\.body\\.[\\w]+(?!.*(?:validate|sanitize|check))',
        description: 'Direct request body usage without validation',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'request\\.(?:GET|POST|data)\\[["\']\\w+["\']\\]',
        description: 'Python request data without validation',
        language: ['python'],
        confidence: 'medium',
      },
      {
        regex: '\\$_(?:GET|POST|REQUEST)\\[["\']\\w+["\']\\]',
        description: 'PHP superglobal without validation',
        language: ['php'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'joi\\.', 'yup\\.', 'zod\\.',
      'validator\\.',
      'is_valid', 'validate',
      'sanitize', 'escape',
    ],
    remediation: 'Validate all input: type, length, format, range. Use allowlists over blocklists. Use validation libraries (Joi, Zod, etc.).',
    references: [
      'https://owasp.org/www-community/vulnerabilities/Improper_Data_Validation',
      'https://cwe.mitre.org/data/definitions/20.html',
    ],
  },

  // Unrestricted File Upload
  {
    id: 'file-upload',
    name: 'Unrestricted File Upload',
    category: 'File Handling',
    cweIds: ['CWE-434', 'CWE-436'],
    owaspCategory: 'A04:2021 - Insecure Design',
    description: 'Allowing upload of dangerous file types can lead to remote code execution.',
    searchPatterns: [
      {
        regex: 'multer\\s*\\(|upload\\.single|upload\\.array',
        description: 'Multer file upload configuration',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
      {
        regex: 'move_uploaded_file\\s*\\(',
        description: 'PHP file upload',
        language: ['php'],
        confidence: 'medium',
      },
      {
        regex: 'file\\.save\\s*\\(|request\\.files\\[',
        description: 'Python/Flask file upload',
        language: ['python'],
        confidence: 'low',
      },
      {
        regex: '\\.originalname|\\.filename(?!.*(?:secure|safe|validate))',
        description: 'Original filename usage without sanitization',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'mimetype', 'content-type',
      'allowed_extensions', 'ALLOWED_TYPES',
      'fileFilter', 'secure_filename',
      'magic\\.from_buffer',
    ],
    remediation: 'Validate file type by content (magic bytes), not just extension. Use allowlists. Generate unique filenames. Store outside webroot.',
    references: [
      'https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload',
      'https://cwe.mitre.org/data/definitions/434.html',
    ],
  },

  // Insufficient Randomness
  {
    id: 'weak-random',
    name: 'Insufficient Randomness',
    category: 'Cryptographic Failures',
    cweIds: ['CWE-330', 'CWE-338'],
    owaspCategory: 'A02:2021 - Cryptographic Failures',
    description: 'Using predictable random values for security-sensitive operations.',
    searchPatterns: [
      {
        regex: 'Math\\.random\\s*\\(\\)',
        description: 'JavaScript Math.random() for security',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'random\\.random\\(\\)|random\\.randint\\(',
        description: 'Python random module for security',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'rand\\(\\)|srand\\(',
        description: 'PHP rand() function',
        language: ['php'],
        confidence: 'high',
      },
      {
        regex: 'new Random\\(\\)|Random\\.Next',
        description: '.NET non-crypto random',
        language: ['csharp'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.cs'],
    antiPatterns: [
      'crypto\\.randomBytes',
      'secrets\\.',
      'SecureRandom',
      'random_bytes',
      'os\\.urandom',
    ],
    remediation: 'Use cryptographically secure random: crypto.randomBytes (Node), secrets module (Python), SecureRandom (Java).',
    references: [
      'https://owasp.org/www-community/vulnerabilities/Insecure_Randomness',
      'https://cwe.mitre.org/data/definitions/330.html',
    ],
  },

  // Missing Rate Limiting
  {
    id: 'rate-limiting',
    name: 'Missing Rate Limiting',
    category: 'API Security',
    cweIds: ['CWE-770', 'CWE-799'],
    owaspCategory: 'A04:2021 - Insecure Design',
    description: 'Endpoints without rate limiting are vulnerable to brute force, DoS, and resource exhaustion.',
    searchPatterns: [
      {
        regex: 'app\\.post\\s*\\(["\']/(login|auth|signin|register|password|forgot)',
        description: 'Auth endpoint without rate limiter',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: '@app\\.route.*methods.*POST.*\\ndef\\s+(login|auth|register)',
        description: 'Python auth route without rate limit',
        language: ['python'],
        confidence: 'medium',
      },
      {
        regex: '@Post\\(["\']/(login|auth|signin)["\'\\)]',
        description: 'NestJS auth endpoint',
        language: ['typescript'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'rateLimit', 'rateLimiter',
      'throttle', 'slowDown',
      '@RateLimit', 'limiter',
    ],
    remediation: 'Implement rate limiting on auth endpoints, APIs, and expensive operations. Use sliding windows and account lockouts.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/04-Test_Number_of_Times_a_Function_Can_Be_Used_Limits',
      'https://cwe.mitre.org/data/definitions/770.html',
    ],
  },

  // Excessive Data Exposure
  {
    id: 'data-exposure',
    name: 'Excessive Data Exposure',
    category: 'API Security',
    cweIds: ['CWE-200', 'CWE-359'],
    owaspCategory: 'A01:2021 - Broken Access Control',
    description: 'APIs returning more data than necessary, exposing sensitive fields.',
    searchPatterns: [
      {
        regex: 'res\\.json\\s*\\(\\s*user\\s*\\)|res\\.send\\s*\\(\\s*user\\s*\\)',
        description: 'Returning full user object',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'return\\s+jsonify\\s*\\(\\s*user\\.to_dict\\s*\\(\\s*\\)\\s*\\)',
        description: 'Python returning full model',
        language: ['python'],
        confidence: 'medium',
      },
      {
        regex: 'SELECT\\s+\\*\\s+FROM',
        description: 'SELECT * query (may include sensitive columns)',
        confidence: 'low',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'DTO', 'Dto',
      '\\.select\\s*\\(',
      'pick\\s*\\(', 'omit\\s*\\(',
      'exclude.*password',
    ],
    remediation: 'Use DTOs with explicit field allowlists. Never return password hashes, internal IDs, or audit fields.',
    references: [
      'https://owasp.org/API-Security/editions/2023/en/0xa3-broken-object-property-level-authorization/',
      'https://cwe.mitre.org/data/definitions/200.html',
    ],
  },

  // Log Injection
  {
    id: 'log-injection',
    name: 'Log Injection',
    category: 'Injection',
    cweIds: ['CWE-117', 'CWE-93'],
    owaspCategory: 'A09:2021 - Security Logging and Monitoring Failures',
    description: 'User input written to logs without sanitization can forge log entries or inject attacks.',
    searchPatterns: [
      {
        regex: 'console\\.log\\s*\\(.*req\\.|logger\\.info\\s*\\(.*req\\.',
        description: 'Logging request data directly',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'logging\\.info\\s*\\(.*request\\.|logger\\.info\\s*\\(.*request\\.',
        description: 'Python logging request data',
        language: ['python'],
        confidence: 'medium',
      },
      {
        regex: 'log\\.Printf\\s*\\(.*\\+|log\\.Println\\s*\\(.*\\+',
        description: 'Go logging with concatenation',
        language: ['go'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.java', '**/*.go'],
    antiPatterns: [
      'sanitize.*log',
      'structured.*logging',
      'JSON\\.stringify',
      'escape.*newline',
    ],
    remediation: 'Sanitize newlines and control characters. Use structured logging with proper escaping.',
    references: [
      'https://owasp.org/www-community/attacks/Log_Injection',
      'https://cwe.mitre.org/data/definitions/117.html',
    ],
  },

  // Debug Mode in Production
  {
    id: 'debug-mode',
    name: 'Debug Mode in Production',
    category: 'Security Misconfiguration',
    cweIds: ['CWE-215', 'CWE-489'],
    owaspCategory: 'A05:2021 - Security Misconfiguration',
    description: 'Debug mode exposes sensitive information like stack traces, environment variables, and source code.',
    searchPatterns: [
      {
        regex: 'DEBUG\\s*=\\s*True|debug\\s*:\\s*true',
        description: 'Debug flag enabled',
        confidence: 'high',
      },
      {
        regex: 'app\\.run\\s*\\(.*debug\\s*=\\s*True',
        description: 'Flask debug mode',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'sourceMap\\s*:\\s*true',
        description: 'Source maps in production',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.env', '**/*.yml', '**/*.yaml', '**/*.json'],
    antiPatterns: [
      'process\\.env\\.NODE_ENV',
      'environment\\.get',
      'IS_PRODUCTION',
    ],
    remediation: 'Use environment-based configuration. Never hardcode debug=true. Disable source maps in production.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/01-Information_Gathering/05-Review_Webpage_Content_for_Information_Leakage',
      'https://cwe.mitre.org/data/definitions/215.html',
    ],
  },

  // Session Fixation
  {
    id: 'session-fixation',
    name: 'Session Fixation',
    category: 'Authentication',
    cweIds: ['CWE-384'],
    owaspCategory: 'A07:2021 - Identification and Authentication Failures',
    description: 'Failure to regenerate session ID after login allows session fixation attacks.',
    searchPatterns: [
      {
        regex: 'req\\.session\\.user\\s*=(?!.*regenerate)',
        description: 'Session assignment without regeneration',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'session\\[["\']user["\']\\]\\s*=(?!.*cycle)',
        description: 'Python session assignment without cycling',
        language: ['python'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'regenerate', 'cycle',
      'session_regenerate_id',
      'invalidate.*session',
    ],
    remediation: 'Regenerate session ID on login and privilege escalation. Invalidate old session.',
    references: [
      'https://owasp.org/www-community/attacks/Session_fixation',
      'https://cwe.mitre.org/data/definitions/384.html',
    ],
  },

  // JWT Misuse
  {
    id: 'jwt-misuse',
    name: 'JWT Misuse',
    category: 'Authentication',
    cweIds: ['CWE-287', 'CWE-347'],
    owaspCategory: 'A07:2021 - Identification and Authentication Failures',
    description: 'Insecure JWT implementation: weak secrets, algorithm confusion, or missing validation.',
    searchPatterns: [
      {
        regex: 'jwt\\.sign\\s*\\([^)]*["\']secret["\']|jwt\\.encode\\s*\\([^)]*["\']secret["\']',
        description: 'Weak JWT secret',
        confidence: 'high',
      },
      {
        regex: 'algorithm\\s*[=:]\\s*["\']none["\']|algorithms\\s*[=:]\\s*\\[["\']none["\']',
        description: 'JWT none algorithm',
        confidence: 'high',
      },
      {
        regex: 'jwt\\.decode\\s*\\([^)]*verify\\s*[=:]\\s*false',
        description: 'JWT without verification',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'jwt\\.verify\\s*\\([^)]*\\{\\s*\\}\\s*\\)',
        description: 'JWT verify with empty options',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'algorithms\\s*[=:]\\s*\\[["\']HS256',
      'process\\.env.*JWT',
      'expiresIn', 'exp\\s*:',
    ],
    remediation: 'Use strong secrets from env vars. Explicitly specify algorithms. Validate expiration and issuer.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/06-Session_Management_Testing/10-Testing_JSON_Web_Tokens',
      'https://cwe.mitre.org/data/definitions/347.html',
    ],
  },

  // Mass Assignment
  {
    id: 'mass-assignment',
    name: 'Mass Assignment',
    category: 'Access Control',
    cweIds: ['CWE-915', 'CWE-1321'],
    owaspCategory: 'A01:2021 - Broken Access Control',
    description: 'Automatically binding request parameters to model objects without filtering allows attackers to modify unintended fields.',
    searchPatterns: [
      {
        regex: 'User\\.create\\s*\\(\\s*req\\.body|Model\\.create\\s*\\(\\s*req\\.body',
        description: 'ORM create with raw request body',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: '\\.update\\s*\\(\\s*\\*\\*request\\.data|\\.update\\s*\\(\\s*\\*\\*request\\.POST',
        description: 'Python model update with request data',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'Object\\.assign\\s*\\(\\s*\\w+\\s*,\\s*req\\.body',
        description: 'Object.assign with request body',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: '\\.findByIdAndUpdate\\s*\\([^,]+,\\s*req\\.body',
        description: 'Mongoose update with raw body',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.rb'],
    antiPatterns: [
      'pick\\s*\\(', 'only\\s*\\(',
      'allowedFields', 'permit\\s*\\(',
      'DTO', 'attr_accessible',
    ],
    remediation: 'Never pass raw request body to ORM. Explicitly pick allowed fields. Use DTOs.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/00-Overview',
      'https://cwe.mitre.org/data/definitions/915.html',
    ],
  },

  // Missing Security Headers
  {
    id: 'security-headers',
    name: 'Missing Security Headers',
    category: 'Security Misconfiguration',
    cweIds: ['CWE-16', 'CWE-693'],
    owaspCategory: 'A05:2021 - Security Misconfiguration',
    description: 'Missing headers like CSP, X-Frame-Options, HSTS leave the application vulnerable to various attacks.',
    searchPatterns: [
      {
        regex: 'app\\.listen\\s*\\((?!.*helmet)',
        description: 'Express without Helmet',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
      {
        regex: 'createServer\\s*\\((?!.*secure)',
        description: 'HTTP server without security headers',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php'],
    antiPatterns: [
      'helmet\\s*\\(',
      'Content-Security-Policy',
      'X-Frame-Options',
      'Strict-Transport-Security',
      'X-Content-Type-Options',
    ],
    remediation: 'Use Helmet.js or equivalent. Set CSP, X-Frame-Options: DENY, HSTS, X-Content-Type-Options: nosniff.',
    references: [
      'https://owasp.org/www-project-secure-headers/',
      'https://cwe.mitre.org/data/definitions/693.html',
    ],
  },

  // Open CORS
  {
    id: 'open-cors',
    name: 'Open CORS Configuration',
    category: 'Security Misconfiguration',
    cweIds: ['CWE-346', 'CWE-942'],
    owaspCategory: 'A05:2021 - Security Misconfiguration',
    description: 'Permissive CORS allows any origin to make authenticated requests.',
    searchPatterns: [
      {
        regex: 'Access-Control-Allow-Origin["\']?\\s*[=:]\\s*["\']\\*["\']',
        description: 'CORS allow all origins',
        confidence: 'high',
      },
      {
        regex: 'cors\\s*\\(\\s*\\)|cors\\s*\\(\\s*\\{\\s*\\}\\s*\\)',
        description: 'CORS with default (permissive) options',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'origin\\s*:\\s*true|credentials\\s*:\\s*true.*origin.*\\*',
        description: 'CORS credentials with wildcard',
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'origin\\s*:\\s*\\[',
      'allowedOrigins',
      'CORS_WHITELIST',
      'ALLOWED_HOSTS',
    ],
    remediation: 'Restrict CORS to known origins. Never use * with credentials. Validate Origin header.',
    references: [
      'https://owasp.org/www-community/attacks/CORS_OriginHeaderScrutiny',
      'https://cwe.mitre.org/data/definitions/346.html',
    ],
  },

  // LDAP Injection
  {
    id: 'ldap-injection',
    name: 'LDAP Injection',
    category: 'Injection',
    cweIds: ['CWE-90'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'User input in LDAP queries without escaping allows filter manipulation.',
    searchPatterns: [
      {
        regex: '\\(uid=.*\\+|\\(cn=.*\\+',
        description: 'LDAP filter with concatenation',
        confidence: 'high',
      },
      {
        regex: 'ldap\\.search\\s*\\([^)]*\\+',
        description: 'LDAP search with user input',
        confidence: 'high',
      },
      {
        regex: 'filter\\s*=.*\\$\\{|filter\\s*=.*%s',
        description: 'LDAP filter with interpolation',
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'escape_ldap', 'ldap_escape',
      'filter_format', 'escape_filter',
    ],
    remediation: 'Escape LDAP special characters: * ( ) \\ NUL. Use LDAP bind for authentication instead of filter.',
    references: [
      'https://owasp.org/www-community/attacks/LDAP_Injection',
      'https://cwe.mitre.org/data/definitions/90.html',
    ],
  },

  // XPath Injection
  {
    id: 'xpath-injection',
    name: 'XPath Injection',
    category: 'Injection',
    cweIds: ['CWE-643'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'User input in XPath queries allows attackers to access unauthorized data.',
    searchPatterns: [
      {
        regex: 'xpath\\s*\\(.*\\+|selectNodes\\s*\\(.*\\+',
        description: 'XPath with string concatenation',
        confidence: 'high',
      },
      {
        regex: 'xmlDoc\\.evaluate\\s*\\([^)]*\\+',
        description: 'JavaScript XPath evaluation with user input',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: '\\.xpath\\s*\\(.*%s|\\.xpath\\s*\\(.*\\$\\{',
        description: 'XPath with string interpolation',
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'parameterized.*xpath',
      'xpath\\.compile',
      'escape.*xpath',
    ],
    remediation: 'Use parameterized XPath queries. Validate and escape user input. Consider using XML libraries with injection protection.',
    references: [
      'https://owasp.org/www-community/attacks/XPATH_Injection',
      'https://cwe.mitre.org/data/definitions/643.html',
    ],
  },

  // Insecure Temp Files
  {
    id: 'insecure-tempfile',
    name: 'Insecure Temporary Files',
    category: 'File Handling',
    cweIds: ['CWE-377', 'CWE-379'],
    owaspCategory: 'A01:2021 - Broken Access Control',
    description: 'Creating temporary files with predictable names or insecure permissions.',
    searchPatterns: [
      {
        regex: 'open\\s*\\(["\']/tmp/|writeFileSync\\s*\\(["\']/tmp/',
        description: 'Writing to predictable /tmp path',
        confidence: 'high',
      },
      {
        regex: 'tempfile\\.mktemp\\s*\\(',
        description: 'Python insecure mktemp',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'File\\.createTempFile(?!.*deleteOnExit)',
        description: 'Java temp file without cleanup',
        language: ['java'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'mkstemp', 'mkdtemp',
      'NamedTemporaryFile',
      'os\\.O_EXCL',
      'deleteOnExit',
    ],
    remediation: 'Use mkstemp/mkdtemp with restrictive permissions (600). Clean up temp files after use.',
    references: [
      'https://owasp.org/www-community/vulnerabilities/Insecure_Temporary_File',
      'https://cwe.mitre.org/data/definitions/377.html',
    ],
  },

  // Verbose Error Messages
  {
    id: 'verbose-errors',
    name: 'Verbose Error Messages',
    category: 'Information Disclosure',
    cweIds: ['CWE-209', 'CWE-210'],
    owaspCategory: 'A05:2021 - Security Misconfiguration',
    description: 'Detailed error messages expose system internals to attackers.',
    searchPatterns: [
      {
        regex: 'res\\.send\\s*\\(\\s*err\\s*\\)|res\\.json\\s*\\(.*error.*message',
        description: 'Sending raw error to client',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'return.*JsonResponse.*exception|return.*str\\s*\\(\\s*e\\s*\\)',
        description: 'Python returning exception details',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'e\\.printStackTrace\\s*\\(\\)',
        description: 'Java stack trace exposure',
        language: ['java'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'generic.*error', 'sanitize.*error',
      'production.*error',
      'logger\\.error',
    ],
    remediation: 'Show generic errors to users. Log detailed errors server-side. Use error IDs for correlation.',
    references: [
      'https://owasp.org/www-community/Improper_Error_Handling',
      'https://cwe.mitre.org/data/definitions/209.html',
    ],
  },

  // Open Redirect
  {
    id: 'open-redirect',
    name: 'Open Redirect',
    category: 'Access Control',
    cweIds: ['CWE-601'],
    owaspCategory: 'A01:2021 - Broken Access Control',
    description: 'Redirecting to user-controlled URLs enables phishing attacks.',
    searchPatterns: [
      {
        regex: 'res\\.redirect\\s*\\(\\s*req\\.(query|params|body)',
        description: 'Express redirect with user input',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'redirect\\s*\\(\\s*request\\.(GET|POST)',
        description: 'Python redirect with request data',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'window\\.location\\s*=.*params|location\\.href\\s*=.*search',
        description: 'Client-side redirect with URL params',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'allowed.*redirect', 'safe.*url',
      'is_safe_url', 'validateRedirect',
      'startsWith\\s*\\(["\']/',
    ],
    remediation: 'Validate redirect URLs against allowlist. Only allow relative paths or trusted domains.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/04-Testing_for_Client-side_URL_Redirect',
      'https://cwe.mitre.org/data/definitions/601.html',
    ],
  },

  // XXE (XML External Entity)
  {
    id: 'xxe',
    name: 'XML External Entity (XXE)',
    category: 'Injection',
    cweIds: ['CWE-611', 'CWE-827'],
    owaspCategory: 'A05:2021 - Security Misconfiguration',
    description: 'Parsing untrusted XML with external entity processing enabled allows file disclosure and SSRF.',
    searchPatterns: [
      {
        regex: 'etree\\.parse\\s*\\(|etree\\.fromstring\\s*\\(',
        description: 'Python XML parsing (potentially unsafe)',
        language: ['python'],
        confidence: 'medium',
      },
      {
        regex: 'DocumentBuilderFactory\\.newInstance\\s*\\(\\)',
        description: 'Java XML parser factory',
        language: ['java'],
        confidence: 'low',
      },
      {
        regex: 'loadXML\\s*\\(|simplexml_load_string\\s*\\(',
        description: 'PHP XML parsing',
        language: ['php'],
        confidence: 'medium',
      },
      {
        regex: 'xml2js\\.parseString|DOMParser\\s*\\(',
        description: 'JavaScript XML parsing',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'resolve_entities\\s*=\\s*False',
      'no_network\\s*=\\s*True',
      'defusedxml',
      'FEATURE_SECURE_PROCESSING',
      'disallow-doctype-decl',
    ],
    remediation: 'Disable external entity processing. Use defusedxml in Python. Set secure parser features in Java.',
    references: [
      'https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing',
      'https://cwe.mitre.org/data/definitions/611.html',
    ],
  },

  // NoSQL Injection
  {
    id: 'nosql-injection',
    name: 'NoSQL Injection',
    category: 'Injection',
    cweIds: ['CWE-943'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'User input in NoSQL queries can manipulate query operators.',
    searchPatterns: [
      {
        regex: 'find\\s*\\(\\s*\\{[^}]*req\\.(body|query|params)',
        description: 'MongoDB find with request data',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: '\\$where\\s*:|\\$regex\\s*:.*req\\.',
        description: 'MongoDB $where or $regex with user input',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'collection\\.find\\s*\\(\\s*request\\.',
        description: 'Python MongoDB with request data',
        language: ['python'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py'],
    antiPatterns: [
      'sanitize.*mongo',
      'mongo-sanitize',
      'express-mongo-sanitize',
    ],
    remediation: 'Sanitize user input. Use explicit field comparisons. Avoid $where operator. Use mongo-sanitize.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.6-Testing_for_NoSQL_Injection',
      'https://cwe.mitre.org/data/definitions/943.html',
    ],
  },

  // Prototype Pollution
  {
    id: 'prototype-pollution',
    name: 'Prototype Pollution',
    category: 'Injection',
    cweIds: ['CWE-1321'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'Merging user input into objects without filtering can pollute Object prototype.',
    searchPatterns: [
      {
        regex: 'Object\\.assign\\s*\\([^,]+,\\s*req\\.',
        description: 'Object.assign with request data',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: '_\\.merge\\s*\\([^,]+,\\s*req\\.|_\\.defaultsDeep\\s*\\(',
        description: 'Lodash deep merge with user data',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: '\\.\\.\\.(req\\.body|req\\.query)',
        description: 'Spread operator with request data',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js'],
    antiPatterns: [
      '__proto__',
      'constructor',
      'prototype',
      'Object\\.freeze',
    ],
    remediation: 'Filter __proto__, constructor, prototype from user input. Use Object.create(null). Update vulnerable lodash.',
    references: [
      'https://portswigger.net/web-security/prototype-pollution',
      'https://cwe.mitre.org/data/definitions/1321.html',
    ],
  },
];

/**
 * Get patterns for a specific vulnerability type
 */
export function getPatternsByType(type: string): VulnerabilityPattern | undefined {
  const normalizedType = type.toLowerCase().replace(/[-_\s]/g, '');

  return VULNERABILITY_PATTERNS.find(p => {
    const normalizedId = p.id.toLowerCase().replace(/[-_\s]/g, '');
    const normalizedName = p.name.toLowerCase().replace(/[-_\s]/g, '');
    return normalizedId.includes(normalizedType) ||
           normalizedType.includes(normalizedId) ||
           normalizedName.includes(normalizedType) ||
           normalizedType.includes(normalizedName);
  });
}

/**
 * Get patterns by CWE ID
 */
export function getPatternsByCWE(cweId: string): VulnerabilityPattern[] {
  return VULNERABILITY_PATTERNS.filter(p =>
    p.cweIds.some(cwe => cwe.toLowerCase() === cweId.toLowerCase())
  );
}

/**
 * Get patterns by category
 */
export function getPatternsByCategory(category: string): VulnerabilityPattern[] {
  return VULNERABILITY_PATTERNS.filter(p =>
    p.category.toLowerCase().includes(category.toLowerCase())
  );
}

/**
 * Build grep patterns for scanning
 */
export function buildGrepPatterns(pattern: VulnerabilityPattern): string[] {
  return pattern.searchPatterns.map(sp => sp.regex);
}

/**
 * Get all patterns as a summary for prompts
 */
export function getPatternsForPrompt(type: string): string {
  const pattern = getPatternsByType(type);
  if (!pattern) {
    return '';
  }

  const lines: string[] = [];
  lines.push(`## ${pattern.name} Detection Patterns`);
  lines.push('');
  lines.push(`**Category:** ${pattern.category}`);
  lines.push(`**CWE IDs:** ${pattern.cweIds.join(', ')}`);
  lines.push('');
  lines.push('**Search Patterns:**');
  pattern.searchPatterns.forEach(sp => {
    lines.push(`- ${sp.description} (${sp.confidence} confidence)`);
    lines.push(`  Regex: \`${sp.regex}\``);
    if (sp.language) {
      lines.push(`  Languages: ${sp.language.join(', ')}`);
    }
  });
  lines.push('');
  lines.push('**File Types to Scan:**');
  lines.push(pattern.filePatterns.join(', '));
  lines.push('');
  lines.push('**Anti-Patterns (secure code indicators):**');
  pattern.antiPatterns?.forEach(ap => lines.push(`- \`${ap}\``));
  lines.push('');
  lines.push(`**Remediation:** ${pattern.remediation}`);

  return lines.join('\n');
}
