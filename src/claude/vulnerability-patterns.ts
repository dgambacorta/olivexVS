/**
 * Vulnerability Pattern Database
 * Contains regex patterns, detection hints, and remediation guidance for common vulnerability types
 */

export interface VulnerabilityPattern {
  id: string;
  name: string;
  category: string;
  cweIds: string[];
  owaspCategory?: string;
  description: string;
  searchPatterns: {
    regex: string;
    description: string;
    language?: string[];
    confidence: 'high' | 'medium' | 'low';
  }[];
  filePatterns: string[];
  antiPatterns?: string[]; // Patterns that indicate secure code (to reduce false positives)
  remediation: string;
  references: string[];
}

/**
 * Common vulnerability patterns database
 */
export const VULNERABILITY_PATTERNS: VulnerabilityPattern[] = [
  // SQL Injection
  {
    id: 'sqli',
    name: 'SQL Injection',
    category: 'Injection',
    cweIds: ['CWE-89', 'CWE-564'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'SQL Injection occurs when untrusted data is sent to an interpreter as part of a command or query.',
    searchPatterns: [
      {
        regex: '(SELECT|INSERT|UPDATE|DELETE|FROM|WHERE).*\\+.*\\$|\\$\\{.*\\}',
        description: 'String concatenation in SQL queries',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'f".*SELECT.*{|f".*INSERT.*{|f".*UPDATE.*{|f".*DELETE.*{',
        description: 'F-string SQL query construction',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: '\\.query\\s*\\(\\s*[`"\'].*\\$\\{',
        description: 'Template literal in database query',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'execute\\s*\\(.*%s.*%|execute\\s*\\(.*\\+',
        description: 'String formatting in SQL execute',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'raw\\s*\\(|rawQuery\\s*\\(',
        description: 'Raw SQL query execution',
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go'],
    antiPatterns: [
      '\\$\\d+', // Parameterized query placeholder ($1, $2)
      '\\?', // Prepared statement placeholder
      'prepare\\s*\\(',
      'parameterized',
    ],
    remediation: 'Use parameterized queries or prepared statements. Never concatenate user input directly into SQL strings.',
    references: [
      'https://owasp.org/www-community/attacks/SQL_Injection',
      'https://cwe.mitre.org/data/definitions/89.html',
    ],
  },

  // XSS (Cross-Site Scripting)
  {
    id: 'xss',
    name: 'Cross-Site Scripting (XSS)',
    category: 'Injection',
    cweIds: ['CWE-79', 'CWE-80'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'XSS attacks occur when an application includes untrusted data in a web page without proper validation or escaping.',
    searchPatterns: [
      {
        regex: 'innerHTML\\s*=|outerHTML\\s*=',
        description: 'Direct innerHTML assignment',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'dangerouslySetInnerHTML',
        description: 'React dangerouslySetInnerHTML usage',
        language: ['javascript', 'typescript', 'jsx', 'tsx'],
        confidence: 'medium',
      },
      {
        regex: 'document\\.write\\s*\\(',
        description: 'document.write usage',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'v-html\\s*=',
        description: 'Vue v-html directive',
        language: ['vue'],
        confidence: 'medium',
      },
      {
        regex: '\\{\\{\\{.*\\}\\}\\}|\\{\\{\\s*!',
        description: 'Unescaped template output',
        confidence: 'high',
      },
      {
        regex: '\\|\\s*safe\\s*\\}\\}',
        description: 'Django/Jinja safe filter',
        language: ['python', 'html'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.jsx', '**/*.tsx', '**/*.vue', '**/*.html', '**/*.php'],
    antiPatterns: [
      'textContent\\s*=',
      'createTextNode',
      'encodeURIComponent',
      'DOMPurify',
      'sanitize',
    ],
    remediation: 'Encode all user input before rendering. Use textContent instead of innerHTML. Implement Content Security Policy.',
    references: [
      'https://owasp.org/www-community/attacks/xss/',
      'https://cwe.mitre.org/data/definitions/79.html',
    ],
  },

  // Command Injection
  {
    id: 'cmdi',
    name: 'Command Injection',
    category: 'Injection',
    cweIds: ['CWE-78', 'CWE-77'],
    owaspCategory: 'A03:2021 - Injection',
    description: 'Command injection occurs when an application passes unsafe user data to a system shell.',
    searchPatterns: [
      {
        regex: 'exec\\s*\\(.*\\+|exec\\s*\\(.*\\$\\{|exec\\s*\\(.*%',
        description: 'exec with string concatenation',
        confidence: 'high',
      },
      {
        regex: 'spawn\\s*\\(.*\\+|spawn\\s*\\(.*\\$\\{',
        description: 'spawn with dynamic command',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'child_process|subprocess|os\\.system|os\\.popen',
        description: 'Process execution imports',
        confidence: 'low',
      },
      {
        regex: 'shell\\s*=\\s*True|shell=True',
        description: 'Python subprocess with shell=True',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'Runtime\\.getRuntime\\(\\)\\.exec',
        description: 'Java Runtime.exec',
        language: ['java'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go', '**/*.rb'],
    antiPatterns: [
      'execFile\\s*\\(',
      'spawnSync\\s*\\([^,]+,\\s*\\[',
      'shlex\\.quote',
      'escapeshellarg',
    ],
    remediation: 'Avoid calling OS commands with user input. If necessary, use allowlists and proper escaping.',
    references: [
      'https://owasp.org/www-community/attacks/Command_Injection',
      'https://cwe.mitre.org/data/definitions/78.html',
    ],
  },

  // Path Traversal
  {
    id: 'path-traversal',
    name: 'Path Traversal',
    category: 'Injection',
    cweIds: ['CWE-22', 'CWE-23'],
    owaspCategory: 'A01:2021 - Broken Access Control',
    description: 'Path traversal attacks use special characters to access files outside the intended directory.',
    searchPatterns: [
      {
        regex: 'readFile.*\\+|readFileSync.*\\+',
        description: 'File read with concatenation',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'path\\.join\\s*\\([^)]*req\\.|path\\.resolve\\s*\\([^)]*req\\.',
        description: 'Path join with request data',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'open\\s*\\(.*\\+|open\\s*\\(.*%|open\\s*\\(.*f"',
        description: 'File open with user input',
        language: ['python'],
        confidence: 'medium',
      },
      {
        regex: 'sendFile\\s*\\(.*req\\.',
        description: 'Express sendFile with request data',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go'],
    antiPatterns: [
      'path\\.basename',
      'path\\.normalize',
      '\\.startsWith\\s*\\(',
      'realpath',
    ],
    remediation: 'Validate and sanitize file paths. Use basename to extract filename. Restrict access to specific directories.',
    references: [
      'https://owasp.org/www-community/attacks/Path_Traversal',
      'https://cwe.mitre.org/data/definitions/22.html',
    ],
  },

  // Insecure Deserialization
  {
    id: 'deserialization',
    name: 'Insecure Deserialization',
    category: 'Injection',
    cweIds: ['CWE-502'],
    owaspCategory: 'A08:2021 - Software and Data Integrity Failures',
    description: 'Insecure deserialization can allow attackers to execute code, bypass authentication, or escalate privileges.',
    searchPatterns: [
      {
        regex: 'pickle\\.loads?\\s*\\(|yaml\\.load\\s*\\([^)]*$|yaml\\.unsafe_load',
        description: 'Python unsafe deserialization',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'unserialize\\s*\\(|serialize\\s*\\(',
        description: 'PHP serialize/unserialize',
        language: ['php'],
        confidence: 'medium',
      },
      {
        regex: 'JSON\\.parse\\s*\\([^)]*\\)',
        description: 'JSON.parse (check for eval-like behavior)',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
      {
        regex: 'ObjectInputStream|readObject\\s*\\(',
        description: 'Java object deserialization',
        language: ['java'],
        confidence: 'medium',
      },
      {
        regex: 'eval\\s*\\(|Function\\s*\\(',
        description: 'Dynamic code evaluation',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'yaml\\.safe_load',
      'JSON\\.parse.*catch',
    ],
    remediation: 'Use safe deserialization methods. Validate and sanitize serialized data. Implement integrity checks.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/07-Testing_for_XML_Injection',
      'https://cwe.mitre.org/data/definitions/502.html',
    ],
  },

  // Hardcoded Secrets
  {
    id: 'hardcoded-secrets',
    name: 'Hardcoded Secrets',
    category: 'Sensitive Data Exposure',
    cweIds: ['CWE-798', 'CWE-259'],
    owaspCategory: 'A02:2021 - Cryptographic Failures',
    description: 'Hardcoded passwords, API keys, or other secrets in source code can be extracted by attackers.',
    searchPatterns: [
      {
        regex: '(password|passwd|pwd|secret|api_key|apikey|api-key|token|auth)\\s*[=:]\\s*["\'][^"\']{8,}["\']',
        description: 'Hardcoded credentials pattern',
        confidence: 'high',
      },
      {
        regex: 'AWS[A-Za-z0-9]{16,}|AKIA[A-Z0-9]{16}',
        description: 'AWS access key pattern',
        confidence: 'high',
      },
      {
        regex: 'sk_live_[a-zA-Z0-9]{24,}|pk_live_[a-zA-Z0-9]{24,}',
        description: 'Stripe API key pattern',
        confidence: 'high',
      },
      {
        regex: 'ghp_[a-zA-Z0-9]{36}|github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59}',
        description: 'GitHub token pattern',
        confidence: 'high',
      },
      {
        regex: 'Bearer\\s+[a-zA-Z0-9\\-_.~+/]+=*',
        description: 'Bearer token pattern',
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go', '**/*.env', '**/*.yml', '**/*.yaml', '**/*.json'],
    antiPatterns: [
      'process\\.env',
      'os\\.environ',
      'getenv\\s*\\(',
      'config\\.',
      'ENV\\[',
    ],
    remediation: 'Use environment variables or secret management systems. Never commit secrets to version control.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/01-Information_Gathering/05-Review_Webpage_Content_for_Information_Leakage',
      'https://cwe.mitre.org/data/definitions/798.html',
    ],
  },

  // SSRF (Server-Side Request Forgery)
  {
    id: 'ssrf',
    name: 'Server-Side Request Forgery',
    category: 'Server-Side',
    cweIds: ['CWE-918'],
    owaspCategory: 'A10:2021 - Server-Side Request Forgery',
    description: 'SSRF attacks can abuse server functionality to read or update internal resources.',
    searchPatterns: [
      {
        regex: 'fetch\\s*\\(.*req\\.|axios\\s*\\(.*req\\.|http\\.get\\s*\\(.*req\\.',
        description: 'HTTP request with user input URL',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'requests\\.get\\s*\\(.*request\\.|urllib\\.request\\.urlopen\\s*\\(',
        description: 'Python HTTP request with user input',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'curl_exec\\s*\\(|file_get_contents\\s*\\(.*\\$',
        description: 'PHP URL fetch with user input',
        language: ['php'],
        confidence: 'high',
      },
      {
        regex: 'new\\s+URL\\s*\\(.*req\\.',
        description: 'URL construction with request data',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go'],
    antiPatterns: [
      'allowlist',
      'whitelist',
      'isValidUrl',
      'validateUrl',
    ],
    remediation: 'Validate and sanitize user-supplied URLs. Use allowlists for permitted domains. Disable redirects.',
    references: [
      'https://owasp.org/www-community/attacks/Server_Side_Request_Forgery',
      'https://cwe.mitre.org/data/definitions/918.html',
    ],
  },

  // IDOR (Insecure Direct Object Reference)
  {
    id: 'idor',
    name: 'Insecure Direct Object Reference',
    category: 'Access Control',
    cweIds: ['CWE-639', 'CWE-284'],
    owaspCategory: 'A01:2021 - Broken Access Control',
    description: 'IDOR occurs when an application exposes internal implementation objects without proper authorization checks.',
    searchPatterns: [
      {
        regex: 'findById\\s*\\(.*req\\.params|findOne\\s*\\(.*req\\.params',
        description: 'Database query with direct ID from request',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: '\\.get\\s*\\(.*:id|\\[req\\.params\\.id\\]',
        description: 'Direct object access with request ID',
        language: ['javascript', 'typescript'],
        confidence: 'medium',
      },
      {
        regex: 'User\\.objects\\.get\\s*\\(.*request\\.',
        description: 'Django direct object access',
        language: ['python'],
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'req\\.user\\.id',
      'currentUser',
      'authorize',
      'checkPermission',
      'canAccess',
    ],
    remediation: 'Implement proper authorization checks. Verify user ownership before accessing resources.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References',
      'https://cwe.mitre.org/data/definitions/639.html',
    ],
  },

  // Missing Authentication
  {
    id: 'missing-auth',
    name: 'Missing Authentication',
    category: 'Authentication',
    cweIds: ['CWE-306', 'CWE-287'],
    owaspCategory: 'A07:2021 - Identification and Authentication Failures',
    description: 'Endpoints that handle sensitive operations without requiring authentication.',
    searchPatterns: [
      {
        regex: 'app\\.(post|put|delete|patch)\\s*\\([^)]*,\\s*(async\\s*)?\\(req',
        description: 'Express route without auth middleware',
        language: ['javascript', 'typescript'],
        confidence: 'low',
      },
      {
        regex: '@(Post|Put|Delete|Patch)\\s*\\([^)]*\\)\\s*\\n\\s*(async\\s+)?\\w+\\s*\\(',
        description: 'NestJS route without guard',
        language: ['typescript'],
        confidence: 'low',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java'],
    antiPatterns: [
      'authenticate',
      'isAuthenticated',
      'requireAuth',
      '@UseGuards',
      '@login_required',
      'auth\\s*:',
    ],
    remediation: 'Implement authentication middleware for all sensitive endpoints.',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/',
      'https://cwe.mitre.org/data/definitions/306.html',
    ],
  },

  // Weak Cryptography
  {
    id: 'weak-crypto',
    name: 'Weak Cryptography',
    category: 'Cryptographic Failures',
    cweIds: ['CWE-327', 'CWE-328'],
    owaspCategory: 'A02:2021 - Cryptographic Failures',
    description: 'Use of weak or broken cryptographic algorithms.',
    searchPatterns: [
      {
        regex: 'createHash\\s*\\(["\']md5["\']\\)|createHash\\s*\\(["\']sha1["\']\\)',
        description: 'Weak hash algorithm (MD5/SHA1)',
        language: ['javascript', 'typescript'],
        confidence: 'high',
      },
      {
        regex: 'hashlib\\.md5|hashlib\\.sha1',
        description: 'Python weak hash',
        language: ['python'],
        confidence: 'high',
      },
      {
        regex: 'DES|3DES|RC4|RC2|Blowfish',
        description: 'Weak encryption algorithm',
        confidence: 'high',
      },
      {
        regex: 'Math\\.random\\s*\\(|rand\\s*\\(\\)',
        description: 'Non-cryptographic random',
        confidence: 'medium',
      },
    ],
    filePatterns: ['**/*.ts', '**/*.js', '**/*.py', '**/*.php', '**/*.java', '**/*.go'],
    antiPatterns: [
      'sha256',
      'sha384',
      'sha512',
      'bcrypt',
      'argon2',
      'scrypt',
      'crypto\\.randomBytes',
      'secrets\\.',
    ],
    remediation: 'Use strong cryptographic algorithms (SHA-256+, AES-256, bcrypt/argon2 for passwords).',
    references: [
      'https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/',
      'https://cwe.mitre.org/data/definitions/327.html',
    ],
  },
];

/**
 * Get patterns for a specific vulnerability type
 */
export function getPatternsByType(type: string): VulnerabilityPattern | undefined {
  const normalizedType = type.toLowerCase().replace(/[-_\s]/g, '');

  return VULNERABILITY_PATTERNS.find(p => {
    const normalizedId = p.id.toLowerCase().replace(/[-_\s]/g, '');
    const normalizedName = p.name.toLowerCase().replace(/[-_\s]/g, '');
    return normalizedId.includes(normalizedType) ||
           normalizedType.includes(normalizedId) ||
           normalizedName.includes(normalizedType) ||
           normalizedType.includes(normalizedName);
  });
}

/**
 * Get patterns by CWE ID
 */
export function getPatternsByCWE(cweId: string): VulnerabilityPattern[] {
  return VULNERABILITY_PATTERNS.filter(p =>
    p.cweIds.some(cwe => cwe.toLowerCase() === cweId.toLowerCase())
  );
}

/**
 * Get patterns by category
 */
export function getPatternsByCategory(category: string): VulnerabilityPattern[] {
  return VULNERABILITY_PATTERNS.filter(p =>
    p.category.toLowerCase().includes(category.toLowerCase())
  );
}

/**
 * Build grep patterns for scanning
 */
export function buildGrepPatterns(pattern: VulnerabilityPattern): string[] {
  return pattern.searchPatterns.map(sp => sp.regex);
}

/**
 * Get all patterns as a summary for prompts
 */
export function getPatternsForPrompt(type: string): string {
  const pattern = getPatternsByType(type);
  if (!pattern) {
    return '';
  }

  const lines: string[] = [];
  lines.push(`## ${pattern.name} Detection Patterns`);
  lines.push('');
  lines.push(`**Category:** ${pattern.category}`);
  lines.push(`**CWE IDs:** ${pattern.cweIds.join(', ')}`);
  lines.push('');
  lines.push('**Search Patterns:**');
  pattern.searchPatterns.forEach(sp => {
    lines.push(`- ${sp.description} (${sp.confidence} confidence)`);
    lines.push(`  Regex: \`${sp.regex}\``);
    if (sp.language) {
      lines.push(`  Languages: ${sp.language.join(', ')}`);
    }
  });
  lines.push('');
  lines.push('**File Types to Scan:**');
  lines.push(pattern.filePatterns.join(', '));
  lines.push('');
  lines.push('**Anti-Patterns (secure code indicators):**');
  pattern.antiPatterns?.forEach(ap => lines.push(`- \`${ap}\``));
  lines.push('');
  lines.push(`**Remediation:** ${pattern.remediation}`);

  return lines.join('\n');
}
